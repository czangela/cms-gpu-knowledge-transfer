
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.0.0b1">
    
    
      
        <title>gpuCalibPixel.h - calibPixels - CMS Tracker DPG - knowledge transfer workshop</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.450eaa28.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>function __md_scope(e,t,_){return new URL(_||(t===localStorage?"../..":"../.."),location).pathname+"."+e}function __md_get(e,t=localStorage,_){return JSON.parse(t.getItem(__md_scope(e,t,_)))}function __md_set(e,t,_=localStorage,o){try{_.setItem(__md_scope(e,_,o),JSON.stringify(t))}catch(e){}}</script>
    
      

  


  

  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-ZZ8D6PMHP5"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-ZZ8D6PMHP5",{page_path:e.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZZ8D6PMHP5"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#gpucalibpixelh-calibpixels" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CMS Tracker DPG - knowledge transfer workshop" class="md-header__button md-logo" aria-label="CMS Tracker DPG - knowledge transfer workshop" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CMS Tracker DPG - knowledge transfer workshop
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              gpuCalibPixel.h - calibPixels
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CMS Tracker DPG - knowledge transfer workshop" class="md-nav__button md-logo" aria-label="CMS Tracker DPG - knowledge transfer workshop" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    CMS Tracker DPG - knowledge transfer workshop
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting-started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting-started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting-started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        Connecting to GPU machines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/software/" class="md-nav__link">
        General CMSSW developer guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/validation/" class="md-nav__link">
        Workflows
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Documentation" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gpuClustering/" class="md-nav__link">
        gpuClustering.h - findClus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gpuClustering02/" class="md-nav__link">
        gpuClustering.h - countModules
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          gpuCalibPixel.h - calibPixels
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        gpuCalibPixel.h - calibPixels
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-init" class="md-nav__link">
    1. Init
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-adc-to-vcal" class="md-nav__link">
    2. ADC to VCAL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-vcal-to-electrons-charge" class="md-nav__link">
    3. VCAL to electrons (charge)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-min-electron-cut" class="md-nav__link">
    4. min electron cut
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-conclusion" class="md-nav__link">
    5. Conclusion
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#citations" class="md-nav__link">
    Citations
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Archive
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Archive" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Archive
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/" class="md-nav__link">
        Archived resources
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-init" class="md-nav__link">
    1. Init
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-adc-to-vcal" class="md-nav__link">
    2. ADC to VCAL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-vcal-to-electrons-charge" class="md-nav__link">
    3. VCAL to electrons (charge)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-min-electron-cut" class="md-nav__link">
    4. min electron cut
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-conclusion" class="md-nav__link">
    5. Conclusion
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#citations" class="md-nav__link">
    Citations
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
<h1 id="gpucalibpixelh-calibpixels">gpuCalibPixel.h - calibPixels</h1>
<p>The whole kernel:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">isRun2</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">calibDigis</span><span class="p">(</span><span class="kt">uint16_t</span><span class="o">*</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="kt">uint16_t</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="kt">uint16_t</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="kt">uint16_t</span><span class="o">*</span><span class="w"> </span><span class="n">adc</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">SiPixelGainForHLTonGPU</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">ped</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="kt">int</span><span class="w"> </span><span class="n">numElements</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="kt">uint32_t</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">moduleStart</span><span class="p">,</span><span class="w">        </span><span class="c1">// just to zero first</span>
<span class="w">                             </span><span class="kt">uint32_t</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">nClustersInModule</span><span class="p">,</span><span class="w">  </span><span class="c1">// just to zero them</span>
<span class="w">                             </span><span class="kt">uint32_t</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">clusModuleStart</span><span class="w">     </span><span class="c1">// just to zero first</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// zero for next kernels...</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">first</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">clusModuleStart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moduleStart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">phase1PixelTopology</span><span class="o">::</span><span class="n">numberOfModules</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">nClustersInModule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numElements</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">invalidModuleId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">isDeadColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">isNoisyColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ped</span><span class="o">-&gt;</span><span class="n">getPedAndGain</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">isDeadColumn</span><span class="p">,</span><span class="w"> </span><span class="n">isNoisyColumn</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">pedestal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="c1">// float pedestal = 0; float gain = 1.;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isDeadColumn</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">isNoisyColumn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;bad pixel at %d in %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invalidModuleId</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">adc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">vcal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="p">(</span><span class="n">adc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pedestal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gain</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">constexpr</span><span class="w"> </span><span class="p">(</span><span class="n">isRun2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kt">float</span><span class="w"> </span><span class="n">conversionFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nl">VCaltoElectronGain_L1</span> <span class="p">:</span><span class="w"> </span><span class="n">VCaltoElectronGain</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kt">float</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nl">VCaltoElectronOffset_L1</span> <span class="p">:</span><span class="w"> </span><span class="n">VCaltoElectronOffset</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">vcal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">conversionFactor</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">adc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">vcal</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<h2 id="1-init">1. Init</h2>
<p>This part of the code has nothing to do with calibrating pixels. We're initialising <code>clusModuleStart</code> and <code>moduleStart</code> as well as <code>nClustersInModule</code>. Even if we have effectively zero digis in this event we still need to call this kernel for these initialisations to happen. </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// zero for next kernels...</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">first</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">clusModuleStart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moduleStart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">phase1PixelTopology</span><span class="o">::</span><span class="n">numberOfModules</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">gridDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">nClustersInModule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<h2 id="2-adc-to-vcal">2. ADC to VCAL</h2>
<p>Converting from <code>ADC</code> to <code>VCAL</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">auto</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ped</span><span class="o">-&gt;</span><span class="n">getPedAndGain</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">isDeadColumn</span><span class="p">,</span><span class="w"> </span><span class="n">isNoisyColumn</span><span class="p">);</span><span class="w"></span>
<span class="kt">float</span><span class="w"> </span><span class="n">pedestal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="kt">float</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<p>...</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">float</span><span class="w"> </span><span class="n">vcal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="p">(</span><span class="n">adc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pedestal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gain</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<p>Note that to determine the <code>gain</code> and <code>pedestal</code> values the inverse of them is measured. This is done by injecting different <code>VCAL</code> values to the detector and measuring the <code>ADC</code> response.</p>
<div class="admonition quote">
<p class="admonition-title">From Offline calibrations and performance of the CMS pixel detector [#1]</p>
<p>In the second step of the ADC-to-charge calibration, a polynomial of first degree is fit to the ADC vs
charge measurements. The fit is performed in a restricted VCAL range to minimize the influence of the
non-linearities at high charge. The resulting two parameters (gain and pedestal) are displayed in Fig. 2 as
obtained in a calibration run from October 2009. The
gain is the inverse slope and the pedestal is the offset
in Fig. 1. The parameters are very stable and are determined about every four months for control purposes.</p>
</div>
<figure>
<p><img alt="vcal_adc_response" src="../../img/documentation/adc_vcal.jpg" /></p>
<figcaption>Figure 1. Example ADC response as a function of injected charge in
VCAL units (see text for conversion to electrons). The red line is a
first degree polynomial fit to the data in a restricted VCAL range 
<a href=https://doi.org/10.1016/j.nima.2010.11.188>https://doi.org/10.1016/j.nima.2010.11.188</a>
</figcaption>
</figure>
<figure>
<p><img alt="gain_and_pedestal" src="../../img/documentation/gainpedestal.png" /></p>
<figcaption>Figure 2. Distributions of the gain and pedestal constants for each
pixel as obtained in a dedicated calibration run in October 2009.
<a href=https://doi.org/10.1016/j.nima.2010.11.188>https://doi.org/10.1016/j.nima.2010.11.188</a>
</figcaption>
</figure>
<p>Some more recent slides from <a href="https://indico.cern.ch/event/914013/#10-gain-calibration-for-run3-p">https://indico.cern.ch/event/914013/#10-gain-calibration-for-run3-p</a>:</p>
<p><img alt="adc_vcal" src="../../img/documentation/m4.png" /></p>
<h2 id="3-vcal-to-electrons-charge">3. VCAL to electrons (charge)</h2>
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">VCAL to charge conversion (up to Run2)</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">constexpr</span><span class="w"> </span><span class="p">(</span><span class="n">isRun2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">conversionFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nl">VCaltoElectronGain_L1</span> <span class="p">:</span><span class="w"> </span><span class="n">VCaltoElectronGain</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">96</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nl">VCaltoElectronOffset_L1</span> <span class="p">:</span><span class="w"> </span><span class="n">VCaltoElectronOffset</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">vcal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">conversionFactor</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<div class="admonition quote">
<p class="admonition-title">From Offline calibrations and performance of the CMS pixel detector [#1]</p>
<p>The ADC-to-charge calibration proceeds in two steps. First, in a dedicated standalone calibration run
(3–6 hour duration, depending on the setup) of the pixel detector, all pixels are subject to charge injection
from around 4000 electrons into the saturation regime
(&gt; 50000 electrons). ... The charge injection is controlled by a digital-to-analog-converter
called VCAL. The relation between VCAL and injected charge Q in electrons, Q = 65.5×VCAL−414, has been
obtained from dedicated x-ray source calibrations with
variable x-ray energies (17.44 keV from Mo, 22.10 keV from Ag, and 32.06 keV from Ba, excited from a primary Am source).</p>
</div>
<p>To us, the linear relationship is relevant here <code>Q = 65.5×VCAL−414</code>.</p>
<p><img alt="vcal_electrons" src="../../img/documentation/m5.png" /></p>
<div class="admonition tip">
<p class="admonition-title">Note the difference between Run2 and afterwards</p>
<p>Gain calibration has changed from Run3, for more information read the following resources:</p>
<p><strong>PRs:</strong></p>
<p><a href="https://github.com/cms-sw/cmssw/pull/29333"> pixel mc gain calibration scheme: new GTs for MC Run3, modified Clusterizer conditions for Run3 #29333</a></p>
<p><a href="https://github.com/cms-sw/cmssw/pull/29829"> Add SiPixelVCal DB object for pixel gain calibration #29829</a></p>
<p><strong>Presentations:</strong></p>
<p><a href="https://indico.cern.ch/event/879470/contributions/3796405/attachments/2009273/3356603/pix_off_25_3_gain_calibration_mc.pdf">https://indico.cern.ch/event/879470/contributions/3796405/attachments/2009273/3356603/pix_off_25_3_gain_calibration_mc.pdf</a></p>
<p>From this presentation:</p>
<p>For the phase1 pixels the MC gain constants used to be:</p>
<p><code>gains = 3.17 (0.055)</code></p>
<p><code>pedestal = 16.3 (5.4)</code></p>
<p>same for bpix &amp; fpix.</p>
<p>After the inclusion of the vcal calibration they become:</p>
<p><code>gains = 149(2.6) for L1 158.6(2.8)</code></p>
<p><code>pedestal = 16.7 (5.4) for L1 20.5(5.4)</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">Configuration.Eras.Modifier_run3_common_cff</span> <span class="kn">import</span> <span class="n">run3_common</span>
<span class="n">run3_common</span><span class="o">.</span><span class="n">toModify</span><span class="p">(</span><span class="n">siPixelClusters</span><span class="p">,</span>
    <span class="n">VCaltoElectronGain</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># all gains=1, pedestals=0</span>
    <span class="n">VCaltoElectronGain_L1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">#</span>
    <span class="n">VCaltoElectronOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">#</span>
    <span class="n">VCaltoElectronOffset_L1</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#</span>
<span class="p">)</span>
</code></pre></div>
<p>Practically speaking, we're combining the two linear models, <code>ADC to VCAL</code> and <code>VCAL to #electrons</code> into 1 linear model. So afterwards, our <code>VCAL to electron</code> conversion is only defined for backwards compatibility, it is not used/executed, it doesn't do anything. (<code>slope=1, offset=0</code>)</p>
</div>
<h2 id="4-min-electron-cut">4. min electron cut</h2>
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">minumum electron value becomes 100</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">adc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">vcal</span><span class="p">));</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<p>This is also present in the legacy code.</p>
<h2 id="5-conclusion">5. Conclusion</h2>
<p>From the high level overview, we calculate the charge (#electrons) for some pixel hit. </p>
<p>We receive an <code>ADC</code> value at a specific <code>x</code>, <code>y</code> coordinate in a specific module <code>id[i]</code>, perform the gain calibration <code>ADC-&gt;VCAL and VCAL-&gt;electrons</code> (or <code>ADC-&gt;electrons</code>).</p>
<div class="admonition warning">
<p class="admonition-title">Output #electrons in <code>adc</code> array</p>
<p>We store the output, <code>#electrons</code> in the same storage that we had for input <code>ADCs</code>, the <code>adc</code> array.</p>
</div>
<h2 id="citations">Citations</h2>
<p>[#1]
Urs Langenegger,
Offline calibrations and performance of the CMS pixel detector,
Nuclear Instruments and Methods in Physics Research Section A: Accelerators, Spectrometers, Detectors and Associated Equipment,
Volume 650, Issue 1,
2011,
Pages 25-29,
ISSN 0168-9002,
https://doi.org/10.1016/j.nima.2010.11.188.
(https://www.sciencedirect.com/science/article/pii/S0168900210027385)
Abstract: The CMS pixel detector, divided into barrel and endcap subdetectors, has 66 million pixels. We present the offline algorithms and results for the gain/pedestal and Lorentz angle calibrations. The determination of the optimal clock delay settings with initial data is described. The expected detector performance from Monte Carlo simulations is compared to the real performance in 7TeV proton–proton collisions.
Keywords: Pixel detectors; Calibrations; CMS experiment; LHC detectors</p>
                
              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../gpuClustering02/" class="md-footer__link md-footer__link--prev" aria-label="Previous: gpuClustering.h - countModules" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              gpuClustering.h - countModules
            </div>
          </div>
        </a>
      
      
        
        <a href="../../archive/" class="md-footer__link md-footer__link--next" aria-label="Next: Archived resources" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Archived resources
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "content.tabs.link", "content.code.annotate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.01824240.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.0d86bc28.min.js"></script>
      
    
  </body>
</html>